<!DOCTYPE html>
<html>
  <head>
    <title>JS - Closure (COMEM+ Web Dev)</title>
    <meta charset='utf-8'>

    <link rel='stylesheet' href='../../assets/unsemantic-grid-base.css'>
    <link rel='stylesheet' href='../../assets/unsemantic-grid-desktop.css'>

    <link rel='stylesheet' href='../../assets/fonts/YanoneKaffeesatz/YanoneKaffeesatz.css'>
    <link rel='stylesheet' href='../../assets/fonts/DroidSerif/DroidSerif.css'>
    <link rel='stylesheet' href='../../assets/fonts/UbuntuMono/UbuntuMono.css'>

    <style>
      body {
        font-family: 'Droid Serif';
      }

      h1, h2, h3, h4 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }

      h4 {
        font-size: 30px;
        margin: 1em 0;
      }

      h1 strong, h2 strong, h3 strong, h4 strong, h5 strong, h6 strong {
        text-decoration: underline;
      }

      .image-header h2, .image-header h3, .image-header h4, .image-header h5 .image-header h6 {
        display: none;
      }

      strong em {
        text-decoration: underline;
      }

      center {
        margin: 1em 0;
      }

      .remark-code, .remark-inline-code {
        font-family: 'Ubuntu Mono';
      }

      .remark-inline-code {
        padding: 0 2px;
        background-color: #eee;
        color: indianred;
        border-radius: 3px;
        border: thin solid #dddddd;
      }

      .container {
        clear: both;
      }

      ul li {
        margin-top: 0.4em;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      table th, td {
        padding: 0.2em 0.4em;
      }

      table tbody th, td {
        border-top: 1px solid #c0c0c0;
      }

      pre:first-child {
        margin-top: 0;
      }

      blockquote {
        font-style: italic;
        border-left: 5px solid khaki;
        margin-left: 0;
        padding-left: 35px;
      }

      .center blockquote {
        margin-right: 0;
        padding-right: 35px;
        border-right: 5px solid khaki;
      }

      #slide-logo {
        position: absolute;
        top: 0;
        left: 0;
      }

      #slide-logo img {
        height: 60px;
      }

      .breadcrumbs {
        position: absolute;
        top: 15px;
        left: 5.333em;
        font-size: 15px;
        color: #c0c0c0;
      }

      .breadcrumbs a {
        color: #c0c0c0;
        text-decoration: none;
      }

      .breadcrumbs a:hover {
        text-decoration: underline;
      }

      .center.middle .breadcrumbs {
        display: none;
      }

      #slide-links {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 15px;
        text-align: right;
      }
    </style>
  </head>
  <body>

    <!-- Slides top-left logo -->
    <span id='slide-logo' style='display:none;'><img src='../heig.png' /></span>

    <!-- Slides top-right links -->
    <div id='slide-links' style='display:none;'>
      <!-- GitHub link -->
      <a href='https://github.com/MediaComem/comem-webdev/tree/1f09fbc4d7f7816dc3b1da22f2ee77ff0c2b9838/subjects/js-closure/'><img src='../../assets/github.svg' width='24' height='24' alt='Source code' title='GitHub' /></a>
      <!-- Home link -->
      <a class='home-link' href='https://mediacomem.github.io/comem-webdev-docs/'><img src='../../assets/home.svg' width='24' height='24' alt='Home' title='Home' /></a>
    </div>

    <!-- Remark slides -->
    <textarea id='source'>
class: center, middle
# JS - Closure



What's a Closure?



---
## THIS!.. IS!.. CLOSURE!

.breadcrumbs[<a href="#1">JS - Closure</a>]

Consider this example:

```javascript
function makeYeller() {
	var city = "Sparta";
*   return function yell() {
*       console.log("This is... " + city);
*   };
};

var Leonidas = makeYeller() // stores a new instance of yell()
Leonidas(); // Execution of the yell() instance print : "This is... Sparta"
```
> `yell()` is a **Closure**: a function that have a reference to a variable declared in an outer scope (in this cas, the `city` variable).

When created, instances of `yell()` will permanently keep the reference to `city`, even after `makeYeller()`'s execution.

Thus, when the instance of `yell()` is executed on the last line, it will check its reference to `city`, and print its last known value, which is `"Sparta"`.

???

> In this example, `yell()` can access `city`, because both the function and the variable are declared **inside the same scope**, this of `makeYeller()`.

If you were to create another instance of `yell()`, say by adding this code:

```javascript
var Gerard = makeYeller(); // stores a new instance of yell()
```
This new instance would also keep a reference to `city` (and print `"Sparta"` when called), but it would be a different instance of `yell()` than the one stored in the `Leonidas` variable. To be sure of that, do:

```javascript
console.log(Gerard === Leonidas);
// Will print : false
```

---
## This is not...

.breadcrumbs[<a href="#1">JS - Closure</a>]

For illustration purposes, let's rewrite the previous example like this.

```javascript
function makeYeller() {
	var city = "Sparta";
    return yell;
};

function yell() {
    console.log(city);
};

var Leonidas = yell() // stores the instance of yell()
Leonidas(); // Will raise an ReferenceError
```

The code apparently didn't change that much; all we did was declare `yell()` outside of `makeYeller()`, and yet it's enough to _break all the things_.

`city` is still declared in the scope of `makeYeller()`, but since `yell()` is declared **outside** this scope, it **cannot** access `city` anymore, resulting in a `ReferenceError` when executed.

???

Moreover, in this case, there is only one instance of `yell()`, that is created when the script is firstly executed.

To test it, let's add the same code as before:

```javascript
var Gerard = makeYeller(); // stores the instance of yell()

console.log(Gerard === Leonidas)
// Will print : true
```
Here, `Leonidas` and `Gerard` store an instance of `yell()`, but its the same instance in both case.

---
## Closure in loops

.breadcrumbs[<a href="#1">JS - Closure</a>]

Using closures inside a loop can result in a well-know "bug" _(and possibly some frustration, too)_.

Consider the following code:

```javascript
// Returns an array of 10 instances of the rank() function
function createArmy() {
	var generatedSoldiers = [];
	for (var nb = 1; nb < 11; nb++) {
		var rank = function() {
			console.log("I'm the soldier n°" + nb);
		};
		generatedSoldiers.push(rank);
	}
	return generatedSoldiers;
};

var spartan = createArmy();

// Let's execute all the created functions
spartan.forEach(function( soldierFunc ) {
	soldierFunc();
});
```
> What will be the output of this code, once executed?

???

When we execute all the functions that have been created by the call to `createArmy()`, we could expect the first one to print `"I'm the soldier n°1"`, the second to print `"I'm the soldier n°2"` and so on, until the tenth, that would print `"I'm the soldier n°10"`.

Instead, all the functions will print `"I'm the soldier n°11"`...

---
### Wait... what?

.breadcrumbs[<a href="#1">JS - Closure</a> > <a href="#4">Closure in loops</a>]

In the previous example, the function stored in `rank` is a **closure** : it has a reference to a variable declared in an outer scope.

In this case, `rank` has a reference to the `nb` variable (declared by the `for` block).

```javascript
...
*for (var nb = 1; nb < 11; nb++) {
	var rank = function() {
*       console.log("I'm the soldier n°" + nb);
	};
	...
}
...
```
So each of the 10 instances of `rank` will forever keep a **reference** to the **same** `nb` variable... but not to its **value at the time of the instance's creation!**

The value of `nb` will only be used when the `rank()` instances will be executed, that is **after** the `for` loop is finished.

> And at that time, `nb` will have a value of `11`.

---
### Done right

.breadcrumbs[<a href="#1">JS - Closure</a> > <a href="#4">Closure in loops</a>]

To solve this problem, we have to find a way to capture, not a reference to `nb`, but its value when each function is created. Here is the correct code: 

```javascript
// Returns an array of 10 instances of the rank() function
function createArmy() {
	var generatedSoldiers = [];
*   function makeRank(nbValue) {
*       return function rank() {
*           console.log("I'm the soldier n°" + nbValue);
*       }
*   }
	for (var nb = 1; nb < 11; nb++) {
*       generatedSoldiers.push(makeRank(nb));
	}
	return generatedSoldiers;
};

var spartan = createArmy();

// Let's execute all the created functions
spartan.forEach(function( soldierFunc ) {
	soldierFunc();
});
```
> `makeRank()` returns a `rank()` function that is **closure**: it references the `nbValue` variable, declared in the signature of `makeRank()`.

---
### The revelations

.breadcrumbs[<a href="#1">JS - Closure</a> > <a href="#4">Closure in loops</a>]

The `makeRank()` function is now a **factory**, and returns a new `rank()` function each time it's called.

```javascript
function makeRank(nbValue) {
    return function rank() {
        console.log("I'm the soldier n°" + nbValue);
    }
}
```

The `nbValue` argument is a **local variable** that `rank()` can access.

Each time the `for` loop calls `makeRank()`, the current value of `nb` is passed...

```javascript
for (var nb = 1; nb < 11; nb++) {
*   generatedSoldiers.push(makeRank(nb));
}
```
...this value is copied in a **new** `nbValue` variable, and a **new instance of** `rank()` is returned, that keeps a reference to **this** new `nbValue`.

So, each `rank()` instance keeps a reference to a **different and "personal"** `nbValue` variable, that stores the value `nb` had the moment it was created.

---
class: middle
## References

.breadcrumbs[<a href="#1">JS - Closure</a>]



* [MDN - Closures][closure]

[closure]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Closures
    </textarea>

    <script src='../../assets/remark.min.js'></script>
    <script src='../../assets/jquery-3.1.1.slim.min.js' integrity='sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=' crossorigin='anonymous'></script>
    <script src='../../assets/uri-1.18.7.js'></script>

    <script>
      var slideshow = remark.create({
        highlightLines: true,
        highlightSpans: true,
        countIncrementalSlides: false
      });

      $('#slide-links .home-link').each(function() {
        var $a = $(this);

        var queryParams = URI(window.location.href).search(true);
        if (!queryParams.home || typeof(queryParams.home) != 'string') {
          return;
        }

        if (queryParams.home.match(/^[a-z0-9\-\_\.]+\/[a-z0-9\-\_\.]+(?:#.*)?$/i)) {
          $a.attr('href', 'https://github.com/' + queryParams.home);
        } else {
          $a.attr('href', queryParams.home);
        }
      });

      var slides = $('.remark-slide-content');

      // Remove logo from body and add it to each slide
      $('#slide-logo').remove().prependTo(slides).show();

      // Remove links from body and add them to each slide
      $('#slide-links').remove().prependTo(slides).show();

      // Make all external links open a new window
      $('a[href]').not('[href^="#"]').attr('target', '_blank');
    </script>
  </body>
</html>
